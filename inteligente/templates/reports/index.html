{% extends 'base.html' %}
{% load static %}

{% block title %}Relatórios{% if is_farmer %} - Meus Alimentadores{% else %} - Sistema Completo{% endif %} - SmartFeeder{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Relatórios{% if is_farmer %} - Meus Alimentadores{% else %} - Sistema Completo{% endif %}</h1>
        <p>Análises e estatísticas {% if is_farmer %}dos seus alimentadores{% else %}de todo o sistema{% endif %}</p>
        {% if report_data.scope_label %}
        <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            Dados baseados em {{ report_data.scope_label }}
        </small>
        {% endif %}
    </div>
    <div class="page-actions">
        <select id="periodSelect" class="period-select">
            <option value="last7days">Últimos 7 dias</option>
            <option value="last30days" selected>Últimos 30 dias</option>
            <option value="last3months">Últimos 3 meses</option>
            <option value="last6months">Últimos 6 meses</option>
        </select>
        <button class="btn btn-primary">
            <i class="fas fa-download"></i>
            Exportar PDF
        </button>
    </div>
</div>

{% if context_message %}
<!-- Mensagem quando não há dados -->
<div class="info-box">
    <i class="fas fa-info-circle"></i>
    {{ context_message }}
    {% if is_farmer %}
    <br><br>
    <a href="{% url 'feeder_add' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Cadastrar Primeiro Alimentador
    </a>
    {% endif %}
</div>
{% else %}
<!-- Key Metrics -->
<div class="metrics-grid">
    <div class="metric-card metric-green">
        <div class="metric-content">
            <div class="metric-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <div class="metric-info">
                <h3>{{ report_data.feeding_efficiency }}%</h3>
                <p>Eficiência de Alimentação</p>
                {% if report_data.feeding_efficiency >= 90 %}
                <span class="metric-trend positive">Excelente performance</span>
                {% elif report_data.feeding_efficiency >= 80 %}
                <span class="metric-trend neutral">Performance adequada</span>
                {% else %}
                <span class="metric-trend negative">Necessita atenção</span>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="metric-card metric-blue">
        <div class="metric-content">
            <div class="metric-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="metric-info">
                <h3>{{ report_data.total_consumption }}t</h3>
                <p>Consumo Total{% if is_farmer %} - Seus Alimentadores{% endif %}</p>
                <span class="metric-trend positive">Baseado em {{ report_data.total_feeders }} alimentador{{ report_data.total_feeders|pluralize:"es" }}</span>
            </div>
        </div>
    </div>

    <div class="metric-card metric-orange">
        <div class="metric-content">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-info">
                <h3>{{ report_data.average_level }}%</h3>
                <p>Nível Médio de Ração</p>
                {% if report_data.average_level >= 70 %}
                <span class="metric-trend positive">Níveis adequados</span>
                {% elif report_data.average_level >= 50 %}
                <span class="metric-trend neutral">Monitorar níveis</span>
                {% else %}
                <span class="metric-trend negative">Reabastecer urgente</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Aba do consumo -->
<div class="chart-section">
    <div class="chart-header">
        <h2>Consumo Mensal (t) - Últimos 6 Meses{% if is_farmer %} - Seus Alimentadores{% endif %}</h2>
        <div class="chart-period">
            <i class="fas fa-calendar"></i>
            <span>
                {% if consumption_series %}
                    {% with first=consumption_series.0 last=consumption_series|last %}
                    {{ first.label }} {{ first.year }} - {{ last.label }} {{ last.year }}
                    {% endwith %}
                {% else %}
                    Sem dados disponíveis
                {% endif %}
            </span>
        </div>
    </div>
    <div class="chart-container">
        <div class="chart-bars">
            {% if consumption_series %}
                {% for month_data in consumption_series %}
                {% widthratio month_data.kg consumption_max 100 as bar_height %}
                <div class="chart-bar" data-value="{{ month_data.tonnes }}" style="height: {% if consumption_max > 0 %}{{ bar_height }}%{% else %}0%{% endif %}">
                    <div class="bar-value">{{ month_data.tonnes }}t</div>
                    <div class="bar-label">{{ month_data.label }}</div>
                </div>
                {% endfor %}
            {% else %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-chart-bar" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <p>Nenhum dado de consumo disponível para os últimos 6 meses.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="reports-grid">
    <!-- Perfomance do Sistema -->
    <div class="report-section">
        <h2>Performance {% if is_farmer %}dos Seus Alimentadores{% else %}do Sistema{% endif %}</h2>
        <div class="performance-metrics">
            <div class="performance-item">
                <span class="performance-label">Tempo de Atividade</span>
                <span class="performance-value success">{{ report_data.system_uptime }}%</span>
            </div>
            <div class="performance-item">
                <span class="performance-label">Manutenções Realizadas</span>
                <span class="performance-value info">{{ report_data.maintenance_completed }}</span>
            </div>
            <div class="performance-item">
                <span class="performance-label">Alertas Gerados</span>
                <span class="performance-value {% if report_data.alerts_generated <= 2 %}success{% elif report_data.alerts_generated <= 5 %}warning{% else %}danger{% endif %}">{{ report_data.alerts_generated }}</span>
            </div>
            {% if not is_farmer %}
            <div class="performance-item">
                <span class="performance-label">Total de Alimentadores</span>
                <span class="performance-value info">{{ report_data.total_feeders }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Top Alimentadores -->
    <div class="report-section">
        <h2>{% if is_farmer %}Seus Alimentadores{% else %}Alimentadores Mais Ativos{% endif %}</h2>
        <div class="top-feeders">
            {% for feeder in top_feeders %}
            <div class="feeder-performance">
                <div class="feeder-info">
                    <h4>{{ feeder.name }}</h4>
                    <span class="consumption">{{ feeder.consumption }}t</span>
                    <small class="text-muted">{{ feeder.alerts_count }} alerta{{ feeder.alerts_count|pluralize:"s" }}</small>
                </div>
                <div class="efficiency-bar">
                    <div class="efficiency-progress" style="width: {{ feeder.efficiency }}%"></div>
                    <span class="efficiency-value">{{ feeder.efficiency }}%</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Resumo Principal -->
<div class="summary-section">
    <h2>Resumo Executivo</h2>
    <div class="summary-content">
        {% if is_farmer and not created_by_admin %}
        <!-- Agricultor não adicionado por administrador - resumo em branco -->
        <div class="alert alert-light">
            <i class="fas fa-info-circle"></i>
            <p class="mb-0">Resumo executivo não disponível.</p>
            <small class="text-muted">Entre em contato com o administrador do sistema para obter acesso a análises detalhadas.</small>
        </div>
        {% elif is_farmer and custom_executive_summary %}
        <!-- Resumo personalizado do agricultor -->
        <div class="custom-summary">
            <div class="alert alert-success mb-3">
                <i class="fas fa-user-edit"></i>
                <strong>Resumo Personalizado</strong> - Editado por você
                <a href="{% url 'farmer_profile_edit' %}" class="btn btn-sm btn-outline-primary float-right">
                    <i class="fas fa-edit"></i> Editar
                </a>
            </div>
            <div class="custom-summary-content">
                {{ custom_executive_summary|linebreaks }}
            </div>
        </div>
        {% else %}
        <!-- Resumo automático para admins ou agricultores sem resumo personalizado -->
        <div class="auto-summary">
            {% if is_farmer %}
            <div class="alert alert-info mb-3">
                <i class="fas fa-chart-line"></i>
                <strong>Resumo Automático</strong> - Baseado nos seus dados
                <a href="{% url 'farmer_profile_edit' %}" class="btn btn-sm btn-outline-primary float-right">
                    <i class="fas fa-edit"></i> Personalizar
                </a>
            </div>
            {% endif %}
            
            <p>
                {% if is_farmer %}
                Durante o período analisado, seus {{ report_data.total_feeders }} alimentador{{ report_data.total_feeders|pluralize:"es" }} 
                apresentaram {{ report_data.feeding_efficiency }}% de eficiência de alimentação. O consumo total foi de {{ report_data.total_consumption }}t.
                {% else %}
                Durante o período analisado, o sistema com {{ report_data.total_feeders }} alimentadores apresentou 
                {{ report_data.feeding_efficiency }}% de eficiência geral. O consumo total de ração foi de {{ report_data.total_consumption }}t.
                {% endif %}
            </p>
            <p>
                {% if is_farmer %}
                Seus alimentadores mantiveram {{ report_data.system_uptime }}% de tempo de atividade, com {{ report_data.maintenance_completed }} 
                manutenções realizadas e {{ report_data.alerts_generated }} alerta{{ report_data.alerts_generated|pluralize:"s" }} gerado{{ report_data.alerts_generated|pluralize:"s" }}.
                {% else %}
                O sistema manteve {{ report_data.system_uptime }}% de tempo de atividade, com {{ report_data.maintenance_completed }} manutenções 
                preventivas realizadas e {{ report_data.alerts_generated }} alertas gerados em todo o sistema.
                {% endif %}
            </p>
            <p>
                {% if report_data.alerts_generated <= 2 %}
                Excelente! {% if is_farmer %}Seus alimentadores estão{% else %}O sistema está{% endif %} funcionando de forma otimizada com poucos alertas.
                {% elif report_data.alerts_generated <= 5 %}
                Performance adequada. Recomenda-se monitorar os alimentadores que geram mais alertas.
                {% else %}
                Atenção! Alto número de alertas indica necessidade de manutenção preventiva e otimização do sistema.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Seção de Logs de Alimentação -->
<div class="logs-section">
    <h2>Logs de Alimentação{% if is_farmer %} - Suas Atividades{% endif %}</h2>
    <div class="logs-content">
        <div class="log-list">
            {% if feeding_logs %}
                {% for log in feeding_logs %}
                <div class="log-item log-feeding {% if not log.success %}log-error{% endif %}">
                    <div class="log-icon">
                        {% if log.success %}
                        <i class="fas fa-check-circle"></i>
                        {% else %}
                        <i class="fas fa-times-circle"></i>
                        {% endif %}
                    </div>
                    <div class="log-details">
                        <div class="log-header">
                            <span class="log-feeder">
                                <i class="fas fa-box"></i> {{ log.feeder.name }}
                            </span>
                            <span class="log-amount">
                                <i class="fas fa-weight"></i> {{ log.amount_dispensed }} kg
                            </span>
                            <span class="log-status {% if log.success %}success{% else %}error{% endif %}">
                                {% if log.success %}
                                    <i class="fas fa-check"></i> Sucesso
                                {% else %}
                                    <i class="fas fa-times"></i> Falha
                                {% endif %}
                            </span>
                            {% if log.sender_phone %}
                            <span class="log-phone">
                                <i class="fas fa-phone"></i> {{ log.sender_phone }}
                            </span>
                            {% endif %}
                            {% if log.feeder_level is not None %}
                            <span class="log-level">
                                <i class="fas fa-tachometer-alt"></i> Nível: {{ log.feeder_level }}%
                            </span>
                            {% endif %}
                        </div>
                        {% if log.received_message %}
                        <div class="log-description">
                            <i class="fas fa-sms"></i> {{ log.received_message }}
                        </div>
                        {% endif %}
                        {% if log.error_message %}
                        <div class="log-description error-message">
                            <i class="fas fa-exclamation-triangle"></i> {{ log.error_message }}
                        </div>
                        {% endif %}
                        <div class="log-timestamp">
                            <i class="far fa-clock"></i>
                            {{ log.timestamp|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="log-empty">
                    <i class="fas fa-info-circle"></i>
                    <p>Nenhuma alimentação registrada.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<script>
// Script para alternar entre as abas de logs
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.log-tab');
    const panels = document.querySelectorAll('.log-panel');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs and panels
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Show corresponding panel
            const tabName = this.getAttribute('data-tab');
            document.getElementById(tabName + '-panel').classList.add('active');
        });
    });
});
</script>
{% endblock %}